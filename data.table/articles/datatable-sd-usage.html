<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using .SD for Data Analysis • data.table</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using .SD for Data Analysis">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">data.table</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.12.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-archive fa-lg"></span>
     
    R Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../boot/index.html">boot</a>
    </li>
    <li>
      <a href="../../broom/index.html">broom</a>
    </li>
    <li>
      <a href="../../caret/index.html">caret</a>
    </li>
    <li>
      <a href="../../cluster/index.html">cluster</a>
    </li>
    <li>
      <a href="../../coefplot/index.html">coefplot</a>
    </li>
    <li>
      <a href="../../data.table/index.html">data.table</a>
    </li>
    <li>
      <a href="../../devtools/index.html">devtools</a>
    </li>
    <li>
      <a href="../../dplyr/index.html">dplyr</a>
    </li>
    <li>
      <a href="../../e1071/index.html">e1071</a>
    </li>
    <li>
      <a href="../../forcats/index.html">forcats</a>
    </li>
    <li>
      <a href="../../gbm/index.html">gbm</a>
    </li>
    <li>
      <a href="../../ggplot2/index.html">ggplot2</a>
    </li>
    <li>
      <a href="../../glmnet/index.html">glmnet</a>
    </li>
    <li>
      <a href="../../gridExtra/index.html">gridExtra</a>
    </li>
    <li>
      <a href="../../ISLR/index.html">ISLR</a>
    </li>
    <li>
      <a href="../../MASS/index.html">MASS</a>
    </li>
    <li>
      <a href="../../pdp/index.html">pdp</a>
    </li>
    <li>
      <a href="../../pls/index.html">pls</a>
    </li>
    <li>
      <a href="../../plyr/index.html">plyr</a>
    </li>
    <li>
      <a href="../../pROC/index.html">pROC</a>
    </li>
    <li>
      <a href="../../purrr/index.html">purrr</a>
    </li>
    <li>
      <a href="../../randomForest/index.html">randomForest</a>
    </li>
    <li>
      <a href="../../readr/index.html">readr</a>
    </li>
    <li>
      <a href="../../rpart/index.html">rpart</a>
    </li>
    <li>
      <a href="../../rpart.plot/index.html">rpart.plot</a>
    </li>
    <li>
      <a href="../../stringr/index.html">stringr</a>
    </li>
    <li>
      <a href="../../tibble/index.html">tibble</a>
    </li>
    <li>
      <a href="../../tidyr/index.html">tidyr</a>
    </li>
    <li>
      <a href="../../xgboost/index.html">xgboost</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/datatable-benchmarking.html">Benchmarking data.table</a>
    </li>
    <li>
      <a href="../articles/datatable-faq.html">Frequently Asked Questions about data.table</a>
    </li>
    <li>
      <a href="../articles/datatable-importing.html">Importing data.table</a>
    </li>
    <li>
      <a href="../articles/datatable-intro.html">Introduction to data.table</a>
    </li>
    <li>
      <a href="../articles/datatable-keys-fast-subset.html">Keys and fast binary search based subset</a>
    </li>
    <li>
      <a href="../articles/datatable-reference-semantics.html">Reference semantics</a>
    </li>
    <li>
      <a href="../articles/datatable-reshape.html">Efficient reshaping using data.tables</a>
    </li>
    <li>
      <a href="../articles/datatable-sd-usage.html">Using .SD for Data Analysis</a>
    </li>
    <li>
      <a href="../articles/datatable-secondary-indices-and-auto-indexing.html">Secondary indices and auto indexing</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/Rdatatable/data.table">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using .SD for Data Analysis</h1>
            
            <h4 class="date">2019-12-31</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/Rdatatable/data.table/blob/master/../../vignettes/datatable-sd-usage.Rmd"><code>../../vignettes/datatable-sd-usage.Rmd</code></a></small>
      <div class="hidden name"><code>datatable-sd-usage.Rmd</code></div>

    </div>

    
    
<p>This vignette will explain the most common ways to use the <code>.SD</code> variable in your <code>data.table</code> analyses. It is an adaptation of <a href="https://stackoverflow.com/a/47406952/3576984">this answer</a> given on StackOverflow.</p>
<div id="what-is--sd" class="section level1">
<h1 class="hasAnchor">
<a href="#what-is--sd" class="anchor"></a>What is <code>.SD</code>?</h1>
<p>In the broadest sense, <code>.SD</code> is just shorthand for capturing a variable that comes up frequently in the context of data analysis. It can be understood to stand for <em>S</em>ubset, <em>S</em>elfsame, or <em>S</em>elf-reference of the <em>D</em>ata. That is, <code>.SD</code> is in its most basic guise a <em>reflexive reference</em> to the <code>data.table</code> itself – as we’ll see in examples below, this is particularly helpful for chaining together “queries” (extractions/subsets/etc using <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code>). In particular, this also means that <code>.SD</code> is <em>itself a <code>data.table</code></em> (with the caveat that it does not allow assignment with <code>:=</code>).</p>
<p>The simpler usage of <code>.SD</code> is for column subsetting (i.e., when <code>.SDcols</code> is specified); as this version is much more straightforward to understand, we’ll cover that first below. The interpretation of <code>.SD</code> in its second usage, grouping scenarios (i.e., when <code>by =</code> or <code>keyby =</code> is specified), is slightly different, conceptually (though at core it’s the same, since, after all, a non-grouped operation is an edge case of grouping with just one group).</p>
<div id="loading-and-previewing-lahman-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-and-previewing-lahman-data" class="anchor"></a>Loading and Previewing Lahman Data</h2>
<p>To give this a more real-world feel, rather than making up data, let’s load some data sets about baseball from the <a href="http://www.seanlahman.com/baseball-archive/statistics/">Lahman database</a>. In typical R usage, we’d simply load these data sets from the <code>Lahman</code> R package; in this vignette, we’ve pre-downloaded them directly from the package’s GitHub page instead.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">'Teams.RData'</span>)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="../reference/setDT.html">setDT</a></span>(Teams)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">Teams</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="co">#       yearID lgID teamID franchID divID Rank   G Ghome  W  L DivWin WCWin LgWin</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#    1:   1871   NA    BS1      BNA  &lt;NA&gt;    3  31    NA 20 10   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6"><span class="co">#    2:   1871   NA    CH1      CNA  &lt;NA&gt;    2  28    NA 19  9   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="co">#    3:   1871   NA    CL1      CFC  &lt;NA&gt;    8  29    NA 10 19   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8"><span class="co">#    4:   1871   NA    FW1      KEK  &lt;NA&gt;    7  19    NA  7 12   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="co">#    5:   1871   NA    NY2      NNA  &lt;NA&gt;    5  33    NA 16 17   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10"><span class="co">#   ---                                                                          </span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="co"># 2891:   2018   NL    SLN      STL     C    3 162    81 88 74      N     N     N</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12"><span class="co"># 2892:   2018   AL    TBA      </span><span class="al">TBD</span><span class="co">     E    3 162    81 90 72      N     N     N</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13"><span class="co"># 2893:   2018   AL    TEX      TEX     W    5 162    81 67 95      N     N     N</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14"><span class="co"># 2894:   2018   AL    TOR      TOR     E    4 162    81 73 89      N     N     N</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="co"># 2895:   2018   NL    WAS      WSN     E    2 162    81 82 80      N     N     N</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16"><span class="co">#       WSWin   R   AB    H X2B X3B  HR  BB   SO  SB CS HBP SF  RA  ER  ERA CG</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17"><span class="co">#    1:  &lt;NA&gt; 401 1372  426  70  37   3  60   19  73 16  NA NA 303 109 3.55 22</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18"><span class="co">#    2:  &lt;NA&gt; 302 1196  323  52  21  10  60   22  69 21  NA NA 241  77 2.76 25</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19"><span class="co">#    3:  &lt;NA&gt; 249 1186  328  35  40   7  26   25  18  8  NA NA 341 116 4.11 23</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20"><span class="co">#    4:  &lt;NA&gt; 137  746  178  19   8   2  33    9  16  4  NA NA 243  97 5.17 19</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21"><span class="co">#    5:  &lt;NA&gt; 302 1404  403  43  21   1  33   15  46 15  NA NA 313 121 3.72 32</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22"><span class="co">#   ---                                                                       </span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="co"># 2891:     N 759 5498 1369 248   9 205 525 1380  63 32  80 48 691 622 3.85  1</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24"><span class="co"># 2892:     N 716 5475 1415 274  43 150 540 1388 128 51 101 50 646 602 3.74  0</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="co"># 2893:     N 737 5453 1308 266  24 194 555 1484  74 35  88 34 848 783 4.92  1</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26"><span class="co"># 2894:     N 709 5477 1336 320  16 217 499 1387  47 30  58 37 832 772 4.85  0</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27"><span class="co"># 2895:     N 771 5517 1402 284  25 191 631 1289 119 33  59 40 682 649 4.04  2</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28"><span class="co">#       SHO SV IPouts   HA HRA BBA  SOA   E  DP    FP                    name</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29"><span class="co">#    1:   1  3    828  367   2  42   23 243  24 0.834    Boston Red Stockings</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30"><span class="co">#    2:   0  1    753  308   6  28   22 229  16 0.829 Chicago White Stockings</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31"><span class="co">#    3:   0  0    762  346  13  53   34 234  15 0.818  Cleveland Forest Citys</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32"><span class="co">#    4:   1  0    507  261   5  21   17 163   8 0.803    Fort Wayne Kekiongas</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33"><span class="co">#    5:   1  0    879  373   7  42   22 235  14 0.840        New York Mutuals</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"><span class="co">#   ---                                                                      </span></a>
<a class="sourceLine" id="cb1-35" data-line-number="35"><span class="co"># 2891:   8 43   4366 1354 144 593 1337 133 151 0.978     St. Louis Cardinals</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36"><span class="co"># 2892:  14 52   4345 1236 164 501 1421  85 136 0.986          Tampa Bay Rays</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37"><span class="co"># 2893:   5 42   4293 1516 222 491 1121 120 168 0.980           Texas Rangers</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="co"># 2894:   3 39   4301 1476 208 551 1298 101 138 0.983       Toronto Blue Jays</span></a>
<a class="sourceLine" id="cb1-39" data-line-number="39"><span class="co"># 2895:   7 40   4338 1320 198 487 1417  64 115 0.989    Washington Nationals</span></a>
<a class="sourceLine" id="cb1-40" data-line-number="40"><span class="co">#                                park attendance BPF PPF teamIDBR teamIDlahman45</span></a>
<a class="sourceLine" id="cb1-41" data-line-number="41"><span class="co">#    1:           South End Grounds I         NA 103  98      BOS            BS1</span></a>
<a class="sourceLine" id="cb1-42" data-line-number="42"><span class="co">#    2:       Union Base-Ball Grounds         NA 104 102      CHI            CH1</span></a>
<a class="sourceLine" id="cb1-43" data-line-number="43"><span class="co">#    3:  National Association Grounds         NA  96 100      CLE            CL1</span></a>
<a class="sourceLine" id="cb1-44" data-line-number="44"><span class="co">#    4:                Hamilton Field         NA 101 107      KEK            FW1</span></a>
<a class="sourceLine" id="cb1-45" data-line-number="45"><span class="co">#    5:      Union Grounds (Brooklyn)         NA  90  88      NYU            NY2</span></a>
<a class="sourceLine" id="cb1-46" data-line-number="46"><span class="co">#   ---                                                                         </span></a>
<a class="sourceLine" id="cb1-47" data-line-number="47"><span class="co"># 2891:             Busch Stadium III    3403587  97  96      STL            SLN</span></a>
<a class="sourceLine" id="cb1-48" data-line-number="48"><span class="co"># 2892:               Tropicana Field    1154973  97  97      TBR            TBA</span></a>
<a class="sourceLine" id="cb1-49" data-line-number="49"><span class="co"># 2893: Rangers Ballpark in Arlington    2107107 112 113      TEX            TEX</span></a>
<a class="sourceLine" id="cb1-50" data-line-number="50"><span class="co"># 2894:                 Rogers Centre    2325281  97  98      TOR            TOR</span></a>
<a class="sourceLine" id="cb1-51" data-line-number="51"><span class="co"># 2895:                Nationals Park    2529604 106 105      WSN            MON</span></a>
<a class="sourceLine" id="cb1-52" data-line-number="52"><span class="co">#       teamIDretro</span></a>
<a class="sourceLine" id="cb1-53" data-line-number="53"><span class="co">#    1:         BS1</span></a>
<a class="sourceLine" id="cb1-54" data-line-number="54"><span class="co">#    2:         CH1</span></a>
<a class="sourceLine" id="cb1-55" data-line-number="55"><span class="co">#    3:         CL1</span></a>
<a class="sourceLine" id="cb1-56" data-line-number="56"><span class="co">#    4:         FW1</span></a>
<a class="sourceLine" id="cb1-57" data-line-number="57"><span class="co">#    5:         NY2</span></a>
<a class="sourceLine" id="cb1-58" data-line-number="58"><span class="co">#   ---            </span></a>
<a class="sourceLine" id="cb1-59" data-line-number="59"><span class="co"># 2891:         SLN</span></a>
<a class="sourceLine" id="cb1-60" data-line-number="60"><span class="co"># 2892:         TBA</span></a>
<a class="sourceLine" id="cb1-61" data-line-number="61"><span class="co"># 2893:         TEX</span></a>
<a class="sourceLine" id="cb1-62" data-line-number="62"><span class="co"># 2894:         TOR</span></a>
<a class="sourceLine" id="cb1-63" data-line-number="63"><span class="co"># 2895:         WAS</span></a>
<a class="sourceLine" id="cb1-64" data-line-number="64"></a>
<a class="sourceLine" id="cb1-65" data-line-number="65"><span class="kw"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="st">'Pitching.RData'</span>)</a>
<a class="sourceLine" id="cb1-66" data-line-number="66"><span class="kw"><a href="../reference/setDT.html">setDT</a></span>(Pitching)</a>
<a class="sourceLine" id="cb1-67" data-line-number="67">Pitching</a>
<a class="sourceLine" id="cb1-68" data-line-number="68"><span class="co">#         playerID yearID stint teamID lgID  W  L  G GS CG SHO SV IPouts   H  ER</span></a>
<a class="sourceLine" id="cb1-69" data-line-number="69"><span class="co">#     1: bechtge01   1871     1    PH1   NA  1  2  3  3  2   0  0     78  43  23</span></a>
<a class="sourceLine" id="cb1-70" data-line-number="70"><span class="co">#     2: brainas01   1871     1    WS3   NA 12 15 30 30 30   0  0    792 361 132</span></a>
<a class="sourceLine" id="cb1-71" data-line-number="71"><span class="co">#     3: fergubo01   1871     1    NY2   NA  0  0  1  0  0   0  0      3   8   3</span></a>
<a class="sourceLine" id="cb1-72" data-line-number="72"><span class="co">#     4: fishech01   1871     1    RC1   NA  4 16 24 24 22   1  0    639 295 103</span></a>
<a class="sourceLine" id="cb1-73" data-line-number="73"><span class="co">#     5: fleetfr01   1871     1    NY2   NA  0  1  1  1  1   0  0     27  20  10</span></a>
<a class="sourceLine" id="cb1-74" data-line-number="74"><span class="co">#    ---                                                                        </span></a>
<a class="sourceLine" id="cb1-75" data-line-number="75"><span class="co"># 46695: zamorda01   2018     1    NYN   NL  1  0 16  0  0   0  0     27   6   3</span></a>
<a class="sourceLine" id="cb1-76" data-line-number="76"><span class="co"># 46696: zastrro01   2018     1    CHN   NL  1  0  6  0  0   0  0     17   6   3</span></a>
<a class="sourceLine" id="cb1-77" data-line-number="77"><span class="co"># 46697: zieglbr01   2018     1    MIA   NL  1  5 53  0  0   0 10    156  49  23</span></a>
<a class="sourceLine" id="cb1-78" data-line-number="78"><span class="co"># 46698: zieglbr01   2018     2    ARI   NL  1  1 29  0  0   0  0     65  22   9</span></a>
<a class="sourceLine" id="cb1-79" data-line-number="79"><span class="co"># 46699: zimmejo02   2018     1    DET   AL  7  8 25 25  0   0  0    394 140  66</span></a>
<a class="sourceLine" id="cb1-80" data-line-number="80"><span class="co">#        HR BB  SO BAOpp   ERA IBB WP HBP BK  BFP GF   R SH SF GIDP</span></a>
<a class="sourceLine" id="cb1-81" data-line-number="81"><span class="co">#     1:  0 11   1    NA  7.96  NA  7  NA  0  146  0  42 NA NA   NA</span></a>
<a class="sourceLine" id="cb1-82" data-line-number="82"><span class="co">#     2:  4 37  13    NA  4.50  NA  7  NA  0 1291  0 292 NA NA   NA</span></a>
<a class="sourceLine" id="cb1-83" data-line-number="83"><span class="co">#     3:  0  0   0    NA 27.00  NA  2  NA  0   14  0   9 NA NA   NA</span></a>
<a class="sourceLine" id="cb1-84" data-line-number="84"><span class="co">#     4:  3 31  15    NA  4.35  NA 20  NA  0 1080  1 257 NA NA   NA</span></a>
<a class="sourceLine" id="cb1-85" data-line-number="85"><span class="co">#     5:  0  3   0    NA 10.00  NA  0  NA  0   57  0  21 NA NA   NA</span></a>
<a class="sourceLine" id="cb1-86" data-line-number="86"><span class="co">#    ---                                                           </span></a>
<a class="sourceLine" id="cb1-87" data-line-number="87"><span class="co"># 46695:  1  3  16 0.194  3.00   1  0   1  0   36  4   3  1  0    1</span></a>
<a class="sourceLine" id="cb1-88" data-line-number="88"><span class="co"># 46696:  0  4   3 0.286  4.76   0  0   1  0   26  2   3  0  0    0</span></a>
<a class="sourceLine" id="cb1-89" data-line-number="89"><span class="co"># 46697:  7 17  37 0.254  3.98   4  1   2  0  213 23  25  0  1   11</span></a>
<a class="sourceLine" id="cb1-90" data-line-number="90"><span class="co"># 46698:  1  8  13 0.265  3.74   2  0   0  0   92  1   9  0  1    3</span></a>
<a class="sourceLine" id="cb1-91" data-line-number="91"><span class="co"># 46699: 28 26 111 0.269  4.52   0  1   2  0  556  0  76  2  5    4</span></a></code></pre></div>
<p>Readers up on baseball lingo should find the tables’ contents familiar; <code>Teams</code> records some statistics for a given team in a given year, while <code>Pitching</code> records statistics for a given pitcher in a given year. Please do check out the <a href="http://www.seanlahman.com/files/database/readme2017.txt">documentation</a> and explore the data yourself a bit before proceeding to familiarize yourself with their structure.</p>
</div>
</div>
<div id="sd-on-ungrouped-data" class="section level1">
<h1 class="hasAnchor">
<a href="#sd-on-ungrouped-data" class="anchor"></a><code>.SD</code> on Ungrouped Data</h1>
<p>To illustrate what I mean about the reflexive nature of <code>.SD</code>, consider its most banal usage:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">Pitching[ , .SD]</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="co">#         playerID yearID stint teamID lgID  W  L  G GS CG SHO SV IPouts   H  ER</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#     1: bechtge01   1871     1    PH1   NA  1  2  3  3  2   0  0     78  43  23</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="co">#     2: brainas01   1871     1    WS3   NA 12 15 30 30 30   0  0    792 361 132</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#     3: fergubo01   1871     1    NY2   NA  0  0  1  0  0   0  0      3   8   3</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">#     4: fishech01   1871     1    RC1   NA  4 16 24 24 22   1  0    639 295 103</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">#     5: fleetfr01   1871     1    NY2   NA  0  1  1  1  1   0  0     27  20  10</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="co">#    ---                                                                        </span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="co"># 46695: zamorda01   2018     1    NYN   NL  1  0 16  0  0   0  0     27   6   3</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="co"># 46696: zastrro01   2018     1    CHN   NL  1  0  6  0  0   0  0     17   6   3</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="co"># 46697: zieglbr01   2018     1    MIA   NL  1  5 53  0  0   0 10    156  49  23</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="co"># 46698: zieglbr01   2018     2    ARI   NL  1  1 29  0  0   0  0     65  22   9</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="co"># 46699: zimmejo02   2018     1    DET   AL  7  8 25 25  0   0  0    394 140  66</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="co">#        HR BB  SO BAOpp   ERA IBB WP HBP BK  BFP GF   R SH SF GIDP</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="co">#     1:  0 11   1    NA  7.96  NA  7  NA  0  146  0  42 NA NA   NA</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="co">#     2:  4 37  13    NA  4.50  NA  7  NA  0 1291  0 292 NA NA   NA</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="co">#     3:  0  0   0    NA 27.00  NA  2  NA  0   14  0   9 NA NA   NA</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="co">#     4:  3 31  15    NA  4.35  NA 20  NA  0 1080  1 257 NA NA   NA</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="co">#     5:  0  3   0    NA 10.00  NA  0  NA  0   57  0  21 NA NA   NA</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"><span class="co">#    ---                                                           </span></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="co"># 46695:  1  3  16 0.194  3.00   1  0   1  0   36  4   3  1  0    1</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22"><span class="co"># 46696:  0  4   3 0.286  4.76   0  0   1  0   26  2   3  0  0    0</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="co"># 46697:  7 17  37 0.254  3.98   4  1   2  0  213 23  25  0  1   11</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="co"># 46698:  1  8  13 0.265  3.74   2  0   0  0   92  1   9  0  1    3</span></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="co"># 46699: 28 26 111 0.269  4.52   0  1   2  0  556  0  76  2  5    4</span></a></code></pre></div>
<p>That is, <code>Pitching[ , .SD]</code> has simply returned the whole table, i.e., this was an overly verbose way of writing <code>Pitching</code> or <code>Pitching[]</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/identical.html">identical</a></span>(Pitching, Pitching[ , .SD])</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co"># [1] TRUE</span></a></code></pre></div>
<p>In terms of subsetting, <code>.SD</code> is still a subset of the data, it’s just a trivial one (the set itself).</p>
<div id="column-subsetting--sdcols" class="section level2">
<h2 class="hasAnchor">
<a href="#column-subsetting--sdcols" class="anchor"></a>Column Subsetting: <code>.SDcols</code>
</h2>
<p>The first way to impact what <code>.SD</code> is is to limit the <em>columns</em> contained in <code>.SD</code> using the <code>.SDcols</code> argument to <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># W: Wins; L: Losses; G: Games</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">Pitching[ , .SD, .SDcols =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'W'</span>, <span class="st">'L'</span>, <span class="st">'G'</span>)]</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">#         W  L  G</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">#     1:  1  2  3</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">#     2: 12 15 30</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co">#     3:  0  0  1</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="co">#     4:  4 16 24</span></a>
<a class="sourceLine" id="cb4-8" data-line-number="8"><span class="co">#     5:  0  1  1</span></a>
<a class="sourceLine" id="cb4-9" data-line-number="9"><span class="co">#    ---         </span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10"><span class="co"># 46695:  1  0 16</span></a>
<a class="sourceLine" id="cb4-11" data-line-number="11"><span class="co"># 46696:  1  0  6</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="co"># 46697:  1  5 53</span></a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co"># 46698:  1  1 29</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co"># 46699:  7  8 25</span></a></code></pre></div>
<p>This is just for illustration and was pretty boring. But even this simply usage lends itself to a wide variety of highly beneficial / ubiquitous data manipulation operations:</p>
</div>
<div id="column-type-conversion" class="section level2">
<h2 class="hasAnchor">
<a href="#column-type-conversion" class="anchor"></a>Column Type Conversion</h2>
<p>Column type conversion is a fact of life for data munging. Though <a href="https://github.com/Rdatatable/data.table/pull/2545"><code>fwrite</code> recently gained the ability to declare the class of each column up front</a>, not all data sets come from <code>fread</code> (e.g. in this vignette) and conversions back and forth among <code>character</code>/<code>factor</code>/<code>numeric</code> types are common. We can use <code>.SD</code> and <code>.SDcols</code> to batch-convert groups of columns to a common type.</p>
<p>We notice that the following columns are stored as <code>character</code> in the <code>Teams</code> data set, but might more logically be stored as <code>factor</code>s:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="co"># teamIDBR: Team ID used by Baseball Reference website</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="co"># teamIDlahman45: Team ID used in Lahman database version 4.5</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co"># teamIDretro: Team ID used by Retrosheet</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">fkt =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'teamIDBR'</span>, <span class="st">'teamIDlahman45'</span>, <span class="st">'teamIDretro'</span>)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="co"># confirm that they're stored as `character`</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">Teams[ , <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(.SD, is.character), .SDcols =<span class="st"> </span>fkt]</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="co">#       teamIDBR teamIDlahman45    teamIDretro </span></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co">#           TRUE           TRUE           TRUE</span></a></code></pre></div>
<p>If you’re confused by the use of <code>sapply</code> here, note that it’s quite similar for base R <code>data.frames</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw"><a href="../reference/setDF.html">setDF</a></span>(Teams) <span class="co"># convert to data.frame for illustration</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(Teams[ , fkt], is.character)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#       teamIDBR teamIDlahman45    teamIDretro </span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#           TRUE           TRUE           TRUE</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw"><a href="../reference/setDT.html">setDT</a></span>(Teams) <span class="co"># convert back to data.table</span></a></code></pre></div>
<p>The key to understanding this syntax is to recall that a <code>data.table</code> (as well as a <code>data.frame</code>) can be considered as a <code>list</code> where each element is a column – thus, <code>sapply</code>/<code>lapply</code> applies the <code>FUN</code> argument (in this case, <code>is.character</code>) to each <em>column</em> and returns the result as <code>sapply</code>/<code>lapply</code> usually would.</p>
<p>The syntax to now convert these columns to <code>factor</code> is very similar – simply add the <code>:=</code> assignment operator:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">Teams[ , (fkt) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(.SD, factor), .SDcols =<span class="st"> </span>fkt]</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co"># print out the first column to demonstrate success</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw"><a href="../reference/duplicated.html">unique</a></span>(Teams[[fkt[1L]]]))</a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="co"># [1] BOS CHI CLE KEK NYU ATH</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co"># 101 Levels: ALT ANA ARI ATH ATL BAL BLA BLN BLU BOS BRA BRG BRO BSN BTT ... WSN</span></a></code></pre></div>
<p>Note that we must wrap <code>fkt</code> in parentheses <code>()</code> to force <code>data.table</code> to interpret this as column names, instead of trying to assign a column named <code>'fkt'</code>.</p>
<p>Actually, the <code>.SDcols</code> argument is quite flexible; above, we supplied a <code>character</code> vector of column names. In other situations, it is more convenient to supply an <code>integer</code> vector of column <em>positions</em> or a <code>logical</code> vector dictating include/exclude for each column. <code>.SDcols</code> even accepts regular expression-based pattern matching.</p>
<p>For example, we could do the following to convert all <code>factor</code> columns to <code>character</code>:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># while .SDcols accepts a logical vector,</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="co">#   := does not, so we need to convert to column</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3"><span class="co">#   positions with which()</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">fkt_idx =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(Teams, is.factor))</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">Teams[ , (fkt_idx) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(.SD, as.character), .SDcols =<span class="st"> </span>fkt_idx]</a>
<a class="sourceLine" id="cb8-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="kw"><a href="../reference/duplicated.html">unique</a></span>(Teams[[fkt_idx[1L]]]))</a>
<a class="sourceLine" id="cb8-7" data-line-number="7"><span class="co"># [1] "NA" "NL" "AA" "UA" "PL" "AL"</span></a></code></pre></div>
<p>Lastly, we can do pattern-based matching of columns in <code>.SDcols</code> to select all columns which contain <code>team</code> back to <code>factor</code>:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">Teams[ , .SD, .SDcols =<span class="st"> </span><span class="kw"><a href="../reference/patterns.html">patterns</a></span>(<span class="st">'team'</span>)]</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#       teamID teamIDBR teamIDlahman45 teamIDretro</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="co">#    1:    BS1      BOS            BS1         BS1</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="co">#    2:    CH1      CHI            CH1         CH1</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#    3:    CL1      CLE            CL1         CL1</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">#    4:    FW1      KEK            FW1         FW1</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="co">#    5:    NY2      NYU            NY2         NY2</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8"><span class="co">#   ---                                           </span></a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="co"># 2891:    SLN      STL            SLN         SLN</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10"><span class="co"># 2892:    TBA      TBR            TBA         TBA</span></a>
<a class="sourceLine" id="cb9-11" data-line-number="11"><span class="co"># 2893:    TEX      TEX            TEX         TEX</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12"><span class="co"># 2894:    TOR      TOR            TOR         TOR</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13"><span class="co"># 2895:    WAS      WSN            MON         WAS</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"></a>
<a class="sourceLine" id="cb9-15" data-line-number="15"><span class="co"># now convert these columns to factor;</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16"><span class="co">#   value = TRUE in grep() is for the LHS of := to</span></a>
<a class="sourceLine" id="cb9-17" data-line-number="17"><span class="co">#   get column names instead of positions</span></a>
<a class="sourceLine" id="cb9-18" data-line-number="18">team_idx =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/grep.html">grep</a></span>(<span class="st">'team'</span>, <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(Teams), <span class="dt">value =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">Teams[ , (team_idx) <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(.SD, factor), .SDcols =<span class="st"> </span>team_idx]</a></code></pre></div>
<p>** A proviso to the above: <em>explicitly</em> using column numbers (like <code>DT[ , (1) := rnorm(.N)]</code>) is bad practice and can lead to silently corrupted code over time if column positions change. Even implicitly using numbers can be dangerous if we don’t keep smart/strict control over the ordering of when we create the numbered index and when we use it.</p>
</div>
<div id="controlling-a-models-right-hand-side" class="section level2">
<h2 class="hasAnchor">
<a href="#controlling-a-models-right-hand-side" class="anchor"></a>Controlling a Model’s Right-Hand Side</h2>
<p>Varying model specification is a core feature of robust statistical analysis. Let’s try and predict a pitcher’s ERA (Earned Runs Average, a measure of performance) using the small set of covariates available in the <code>Pitching</code> table. How does the (linear) relationship between <code>W</code> (wins) and <code>ERA</code> vary depending on which other covariates are included in the specification?</p>
<p>Here’s a short script leveraging the power of <code>.SD</code> which explores this question:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># this generates a list of the 2^k possible extra variables</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#   for models of the form ERA ~ G + (...)</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">extra_var =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'yearID'</span>, <span class="st">'teamID'</span>, <span class="st">'G'</span>, <span class="st">'L'</span>)</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">models =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(0L<span class="op">:</span><span class="kw"><a href="https://rdrr.io/r/base/length.html">length</a></span>(extra_var), combn, <span class="dt">x =</span> extra_var, <span class="dt">simplify =</span> <span class="ot">FALSE</span>),</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="dt">recursive =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb10-8" data-line-number="8"></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="co"># here are 16 visually distinct colors, taken from the list of 20 here:</span></a>
<a class="sourceLine" id="cb10-10" data-line-number="10"><span class="co">#   https://sashat.me/2017/01/11/list-of-20-simple-distinct-colors/</span></a>
<a class="sourceLine" id="cb10-11" data-line-number="11">col16 =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'#e6194b'</span>, <span class="st">'#3cb44b'</span>, <span class="st">'#ffe119'</span>, <span class="st">'#0082c8'</span>,</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">          <span class="st">'#f58231'</span>, <span class="st">'#911eb4'</span>, <span class="st">'#46f0f0'</span>, <span class="st">'#f032e6'</span>,</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">          <span class="st">'#d2f53c'</span>, <span class="st">'#fabebe'</span>, <span class="st">'#008080'</span>, <span class="st">'#e6beff'</span>,</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">          <span class="st">'#aa6e28'</span>, <span class="st">'#fffac8'</span>, <span class="st">'#800000'</span>, <span class="st">'#aaffc3'</span>)</a>
<a class="sourceLine" id="cb10-15" data-line-number="15"></a>
<a class="sourceLine" id="cb10-16" data-line-number="16"><span class="kw"><a href="https://rdrr.io/r/graphics/par.html">par</a></span>(<span class="dt">oma =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb10-17" data-line-number="17">lm_coef =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(models, <span class="cf">function</span>(rhs) {</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">  <span class="co"># using ERA ~ . and data = .SD, then varying which</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">  <span class="co">#   columns are included in .SD allows us to perform this</span></a>
<a class="sourceLine" id="cb10-20" data-line-number="20">  <span class="co">#   iteration over 16 models succinctly.</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">  <span class="co">#   coef(.)['W'] extracts the W coefficient from each model fit</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">  Pitching[ , <span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(ERA <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .SD))[<span class="st">'W'</span>], .SDcols =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'W'</span>, rhs)]</a>
<a class="sourceLine" id="cb10-23" data-line-number="23">})</a>
<a class="sourceLine" id="cb10-24" data-line-number="24"><span class="kw"><a href="https://rdrr.io/r/graphics/barplot.html">barplot</a></span>(lm_coef, <span class="dt">names.arg =</span> <span class="kw"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(models, paste, <span class="dt">collapse =</span> <span class="st">'/'</span>),</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">        <span class="dt">main =</span> <span class="st">'Wins Coefficient</span><span class="ch">\n</span><span class="st">With Various Covariates'</span>,</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">        <span class="dt">col =</span> col16, <span class="dt">las =</span> 2L, <span class="dt">cex.names =</span> <span class="fl">.8</span>)</a></code></pre></div>
<p><img src="datatable-sd-usage_files/figure-html/sd_for_lm-1.png" width="100%"></p>
<p>The coefficient always has the expected sign (better pitchers tend to have more wins and fewer runs allowed), but the magnitude can vary substantially depending on what else we control for.</p>
</div>
<div id="conditional-joins" class="section level2">
<h2 class="hasAnchor">
<a href="#conditional-joins" class="anchor"></a>Conditional Joins</h2>
<p><code>data.table</code> syntax is beautiful for its simplicity and robustness. The syntax <code>x[i]</code> flexibly handles three common approaches to subsetting – when <code>i</code> is a <code>logical</code> vector, <code>x[i]</code> will return those rows of <code>x</code> corresponding to where <code>i</code> is <code>TRUE</code>; when <code>i</code> is <em>another <code>data.table</code></em> (or a <code>list</code>), a (right) <code>join</code> is performed (in the plain form, using the <code>key</code>s of <code>x</code> and <code>i</code>, otherwise, when <code>on =</code> is specified, using matches of those columns); and when <code>i</code> is a character, it is interpreted as shorthand for <code>x[list(i)]</code>, i.e., as a join.</p>
<p>This is great in general, but falls short when we wish to perform a <em>conditional join</em>, wherein the exact nature of the relationship among tables depends on some characteristics of the rows in one or more columns.</p>
<p>This example is admittedly a tad contrived, but illustrates the idea; see here (<a href="https://stackoverflow.com/questions/31329939/conditional-keyed-join-update-and-update-a-flag-column-for-matches">1</a>, <a href="https://stackoverflow.com/questions/29658627/conditional-binary-join-and-update-by-reference-using-the-data-table-package">2</a>) for more.</p>
<p>The goal is to add a column <code>team_performance</code> to the <code>Pitching</code> table that records the team’s performance (rank) of the best pitcher on each team (as measured by the lowest ERA, among pitchers with at least 6 recorded games).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="co"># to exclude pitchers with exceptional performance in a few games,</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#   subset first; then define rank of pitchers within their team each year</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#   (in general, we should put more care into the 'ties.method' of frank)</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">Pitching[G <span class="op">&gt;</span><span class="st"> </span><span class="dv">5</span>, rank_in_team <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw"><a href="../reference/frank.html">frank</a></span>(ERA), by =<span class="st"> </span>.(teamID, yearID)]</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">Pitching[rank_in_team <span class="op">==</span><span class="st"> </span><span class="dv">1</span>, team_performance <span class="op">:</span><span class="er">=</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="st">           </span>Teams[.SD, Rank, on =<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">'teamID'</span>, <span class="st">'yearID'</span>)]]</a></code></pre></div>
<p>Note that the <code>x[y]</code> syntax returns <code><a href="https://rdrr.io/r/base/nrow.html">nrow(y)</a></code> values (i.e., it’s a right join), which is why <code>.SD</code> is on the right in <code>Teams[.SD]</code> (since the RHS of <code>:=</code> in this case requires <code><a href="https://rdrr.io/r/base/nrow.html">nrow(Pitching[rank_in_team == 1])</a></code> values.</p>
</div>
</div>
<div id="grouped--sd-operations" class="section level1">
<h1 class="hasAnchor">
<a href="#grouped--sd-operations" class="anchor"></a>Grouped <code>.SD</code> operations</h1>
<p>Often, we’d like to perform some operation on our data <em>at the group level</em>. When we specify <code>by =</code> (or <code>keyby =</code>), the mental model for what happens when <code>data.table</code> processes <code>j</code> is to think of your <code>data.table</code> as being split into many component sub-<code>data.table</code>s, each of which corresponds to a single value of your <code>by</code> variable(s):</p>
<div class="figure">
<img src="plots/grouping_illustration.png" alt="Grouping, Illustrated" width="100%"><p class="caption">
Grouping, Illustrated
</p>
</div>
<p>In the case of grouping, <code>.SD</code> is multiple in nature – it refers to <em>each</em> of these sub-<code>data.table</code>s, <em>one-at-a-time</em> (slightly more accurately, the scope of <code>.SD</code> is a single sub-<code>data.table</code>). This allows us to concisely express an operation that we’d like to perform on <em>each sub-<code>data.table</code></em> before the re-assembled result is returned to us.</p>
<p>This is useful in a variety of settings, the most common of which are presented here:</p>
<div id="group-subsetting" class="section level2">
<h2 class="hasAnchor">
<a href="#group-subsetting" class="anchor"></a>Group Subsetting</h2>
<p>Let’s get the most recent season of data for each team in the Lahman data. This can be done quite simply with:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># the data is already sorted by year; if it weren't</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="co">#   we could do Teams[order(yearID), .SD[.N], by = teamID]</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">Teams[ , .SD[.N], by =<span class="st"> </span>teamID]</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="co">#      teamID yearID lgID franchID divID Rank   G Ghome  W  L DivWin WCWin LgWin</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co">#   1:    BS1   1875   NA      BNA  &lt;NA&gt;    1  82    NA 71  8   &lt;NA&gt;  &lt;NA&gt;     Y</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="co">#   2:    CH1   1871   NA      CNA  &lt;NA&gt;    2  28    NA 19  9   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="co">#   3:    CL1   1872   NA      CFC  &lt;NA&gt;    7  22    NA  6 16   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="co">#   4:    FW1   1871   NA      KEK  &lt;NA&gt;    7  19    NA  7 12   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#   5:    NY2   1875   NA      NNA  &lt;NA&gt;    6  71    NA 30 38   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#  ---                                                                          </span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co"># 145:    ANA   2004   AL      ANA     W    1 162    81 92 70      Y     N     N</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co"># 146:    ARI   2018   NL      ARI     W    3 162    81 82 80      N     N     N</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co"># 147:    MIL   2018   NL      MIL     C    1 163    81 96 67      Y     N     N</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co"># 148:    TBA   2018   AL      </span><span class="al">TBD</span><span class="co">     E    3 162    81 90 72      N     N     N</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co"># 149:    MIA   2018   NL      FLA     E    5 161    81 63 98      N     N     N</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#      WSWin   R   AB    H X2B X3B  HR  BB   SO  SB CS HBP SF  RA  ER  ERA CG SHO</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17"><span class="co">#   1:  &lt;NA&gt; 831 3515 1128 167  51  15  33   52  93 37  NA NA 343 152 1.87 60  10</span></a>
<a class="sourceLine" id="cb12-18" data-line-number="18"><span class="co">#   2:  &lt;NA&gt; 302 1196  323  52  21  10  60   22  69 21  NA NA 241  77 2.76 25   0</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"><span class="co">#   3:  &lt;NA&gt; 174  943  272  28   5   0  17   13  12  3  NA NA 254 126 5.70 15   0</span></a>
<a class="sourceLine" id="cb12-20" data-line-number="20"><span class="co">#   4:  &lt;NA&gt; 137  746  178  19   8   2  33    9  16  4  NA NA 243  97 5.17 19   1</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21"><span class="co">#   5:  &lt;NA&gt; 328 2685  633  82  21   7  19   47  20 24  NA NA 425 174 2.46 70   3</span></a>
<a class="sourceLine" id="cb12-22" data-line-number="22"><span class="co">#  ---                                                                           </span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"><span class="co"># 145:     N 836 5675 1603 272  37 162 450  942 143 46  73 41 734 692 4.28  2  11</span></a>
<a class="sourceLine" id="cb12-24" data-line-number="24"><span class="co"># 146:     N 693 5460 1283 259  50 176 560 1460  79 25  52 45 644 605 3.72  2   9</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25"><span class="co"># 147:     N 754 5542 1398 252  24 218 537 1458 124 32  58 41 659 606 3.73  0  14</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26"><span class="co"># 148:     N 716 5475 1415 274  43 150 540 1388 128 51 101 50 646 602 3.74  0  14</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27"><span class="co"># 149:     N 589 5488 1303 222  24 128 455 1384  45 31  73 31 809 762 4.76  1  12</span></a>
<a class="sourceLine" id="cb12-28" data-line-number="28"><span class="co">#      SV IPouts   HA HRA BBA  SOA   E  DP    FP                    name</span></a>
<a class="sourceLine" id="cb12-29" data-line-number="29"><span class="co">#   1: 17   2196  751   2  33  110 483  56 0.870    Boston Red Stockings</span></a>
<a class="sourceLine" id="cb12-30" data-line-number="30"><span class="co">#   2:  1    753  308   6  28   22 229  16 0.829 Chicago White Stockings</span></a>
<a class="sourceLine" id="cb12-31" data-line-number="31"><span class="co">#   3:  0    597  285   6  24   11 184  17 0.816  Cleveland Forest Citys</span></a>
<a class="sourceLine" id="cb12-32" data-line-number="32"><span class="co">#   4:  0    507  261   5  21   17 163   8 0.803    Fort Wayne Kekiongas</span></a>
<a class="sourceLine" id="cb12-33" data-line-number="33"><span class="co">#   5:  0   1910  718   4  21   77 526  30 0.838        New York Mutuals</span></a>
<a class="sourceLine" id="cb12-34" data-line-number="34"><span class="co">#  ---                                                                  </span></a>
<a class="sourceLine" id="cb12-35" data-line-number="35"><span class="co"># 145: 50   4363 1476 170 502 1164  90 126 0.985          Anaheim Angels</span></a>
<a class="sourceLine" id="cb12-36" data-line-number="36"><span class="co"># 146: 39   4389 1313 174 522 1448  75 152 0.988    Arizona Diamondbacks</span></a>
<a class="sourceLine" id="cb12-37" data-line-number="37"><span class="co"># 147: 49   4383 1259 173 553 1428 108 141 0.982       Milwaukee Brewers</span></a>
<a class="sourceLine" id="cb12-38" data-line-number="38"><span class="co"># 148: 52   4345 1236 164 501 1421  85 136 0.986          Tampa Bay Rays</span></a>
<a class="sourceLine" id="cb12-39" data-line-number="39"><span class="co"># 149: 30   4326 1388 192 605 1249  83 133 0.986           Miami Marlins</span></a>
<a class="sourceLine" id="cb12-40" data-line-number="40"><span class="co">#                              park attendance BPF PPF teamIDBR teamIDlahman45</span></a>
<a class="sourceLine" id="cb12-41" data-line-number="41"><span class="co">#   1:          South End Grounds I         NA 103  96      BOS            BS1</span></a>
<a class="sourceLine" id="cb12-42" data-line-number="42"><span class="co">#   2:      Union Base-Ball Grounds         NA 104 102      CHI            CH1</span></a>
<a class="sourceLine" id="cb12-43" data-line-number="43"><span class="co">#   3: National Association Grounds         NA  96 100      CLE            CL1</span></a>
<a class="sourceLine" id="cb12-44" data-line-number="44"><span class="co">#   4:               Hamilton Field         NA 101 107      KEK            FW1</span></a>
<a class="sourceLine" id="cb12-45" data-line-number="45"><span class="co">#   5:     Union Grounds (Brooklyn)         NA  99 100      NYU            NY2</span></a>
<a class="sourceLine" id="cb12-46" data-line-number="46"><span class="co">#  ---                                                                        </span></a>
<a class="sourceLine" id="cb12-47" data-line-number="47"><span class="co"># 145:    Angels Stadium of Anaheim    3375677  97  97      ANA            ANA</span></a>
<a class="sourceLine" id="cb12-48" data-line-number="48"><span class="co"># 146:                  Chase Field    2242695 108 107      ARI            ARI</span></a>
<a class="sourceLine" id="cb12-49" data-line-number="49"><span class="co"># 147:                  Miller Park    2850875 102 101      MIL            ML4</span></a>
<a class="sourceLine" id="cb12-50" data-line-number="50"><span class="co"># 148:              Tropicana Field    1154973  97  97      TBR            TBA</span></a>
<a class="sourceLine" id="cb12-51" data-line-number="51"><span class="co"># 149:                 Marlins Park     811104  89  90      MIA            FLO</span></a>
<a class="sourceLine" id="cb12-52" data-line-number="52"><span class="co">#      teamIDretro</span></a>
<a class="sourceLine" id="cb12-53" data-line-number="53"><span class="co">#   1:         BS1</span></a>
<a class="sourceLine" id="cb12-54" data-line-number="54"><span class="co">#   2:         CH1</span></a>
<a class="sourceLine" id="cb12-55" data-line-number="55"><span class="co">#   3:         CL1</span></a>
<a class="sourceLine" id="cb12-56" data-line-number="56"><span class="co">#   4:         FW1</span></a>
<a class="sourceLine" id="cb12-57" data-line-number="57"><span class="co">#   5:         NY2</span></a>
<a class="sourceLine" id="cb12-58" data-line-number="58"><span class="co">#  ---            </span></a>
<a class="sourceLine" id="cb12-59" data-line-number="59"><span class="co"># 145:         ANA</span></a>
<a class="sourceLine" id="cb12-60" data-line-number="60"><span class="co"># 146:         ARI</span></a>
<a class="sourceLine" id="cb12-61" data-line-number="61"><span class="co"># 147:         MIL</span></a>
<a class="sourceLine" id="cb12-62" data-line-number="62"><span class="co"># 148:         TBA</span></a>
<a class="sourceLine" id="cb12-63" data-line-number="63"><span class="co"># 149:         MIA</span></a></code></pre></div>
<p>Recall that <code>.SD</code> is itself a <code>data.table</code>, and that <code>.N</code> refers to the total number of rows in a group (it’s equal to <code><a href="https://rdrr.io/r/base/nrow.html">nrow(.SD)</a></code> within each group), so <code>.SD[.N]</code> returns the <em>entirety of <code>.SD</code></em> for the final row associated with each <code>teamID</code>.</p>
<p>Another common version of this is to use <code>.SD[1L]</code> instead to get the <em>first</em> observation for each group, or <code>.SD[sample(.N, 1L)]</code> to return a <em>random</em> row for each group.</p>
</div>
<div id="group-optima" class="section level2">
<h2 class="hasAnchor">
<a href="#group-optima" class="anchor"></a>Group Optima</h2>
<p>Suppose we wanted to return the <em>best</em> year for each team, as measured by their total number of runs scored (<code>R</code>; we could easily adjust this to refer to other metrics, of course). Instead of taking a <em>fixed</em> element from each sub-<code>data.table</code>, we now define the desired index <em>dynamically</em> as follows:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">Teams[ , .SD[<span class="kw"><a href="https://rdrr.io/r/base/which.min.html">which.max</a></span>(R)], by =<span class="st"> </span>teamID]</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co">#      teamID yearID lgID franchID divID Rank   G Ghome   W  L DivWin WCWin LgWin</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="co">#   1:    BS1   1875   NA      BNA  &lt;NA&gt;    1  82    NA  71  8   &lt;NA&gt;  &lt;NA&gt;     Y</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="co">#   2:    CH1   1871   NA      CNA  &lt;NA&gt;    2  28    NA  19  9   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="co">#   3:    CL1   1871   NA      CFC  &lt;NA&gt;    8  29    NA  10 19   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co">#   4:    FW1   1871   NA      KEK  &lt;NA&gt;    7  19    NA   7 12   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="co">#   5:    NY2   1872   NA      NNA  &lt;NA&gt;    3  56    NA  34 20   &lt;NA&gt;  &lt;NA&gt;     N</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="co">#  ---                                                                           </span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co"># 145:    ANA   2000   AL      ANA     W    3 162    81  82 80      N     N     N</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co"># 146:    ARI   1999   NL      ARI     W    1 162    81 100 62      Y     N     N</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co"># 147:    MIL   1999   NL      MIL     C    5 161    80  74 87      N     N     N</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co"># 148:    TBA   2009   AL      </span><span class="al">TBD</span><span class="co">     E    3 162    81  84 78      N     N     N</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co"># 149:    MIA   2017   NL      FLA     E    2 162    78  77 85      N     N     N</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#      WSWin   R   AB    H X2B X3B  HR  BB   SO  SB CS HBP SF  RA  ER  ERA CG SHO</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#   1:  &lt;NA&gt; 831 3515 1128 167  51  15  33   52  93 37  NA NA 343 152 1.87 60  10</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#   2:  &lt;NA&gt; 302 1196  323  52  21  10  60   22  69 21  NA NA 241  77 2.76 25   0</span></a>
<a class="sourceLine" id="cb13-17" data-line-number="17"><span class="co">#   3:  &lt;NA&gt; 249 1186  328  35  40   7  26   25  18  8  NA NA 341 116 4.11 23   0</span></a>
<a class="sourceLine" id="cb13-18" data-line-number="18"><span class="co">#   4:  &lt;NA&gt; 137  746  178  19   8   2  33    9  16  4  NA NA 243  97 5.17 19   1</span></a>
<a class="sourceLine" id="cb13-19" data-line-number="19"><span class="co">#   5:  &lt;NA&gt; 523 2426  670  87  14   4  58   52  59 22  NA NA 362 172 3.02 54   3</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="co">#  ---                                                                           </span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="co"># 145:     N 864 5628 1574 309  34 236 608 1024  93 52  47 43 869 805 5.00  5   3</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="co"># 146:     N 908 5658 1566 289  46 216 588 1045 137 39  48 60 676 615 3.77 16   9</span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="co"># 147:     N 815 5582 1524 299  30 165 658 1065  81 33  55 51 886 813 5.07  2   5</span></a>
<a class="sourceLine" id="cb13-24" data-line-number="24"><span class="co"># 148:     N 803 5462 1434 297  36 199 642 1229 194 61  49 45 754 686 4.33  3   5</span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25"><span class="co"># 149:     N 778 5602 1497 271  31 194 486 1282  91 30  67 41 822 772 4.82  1   7</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26"><span class="co">#      SV IPouts   HA HRA BBA  SOA   E  DP    FP                    name</span></a>
<a class="sourceLine" id="cb13-27" data-line-number="27"><span class="co">#   1: 17   2196  751   2  33  110 483  56 0.870    Boston Red Stockings</span></a>
<a class="sourceLine" id="cb13-28" data-line-number="28"><span class="co">#   2:  1    753  308   6  28   22 229  16 0.829 Chicago White Stockings</span></a>
<a class="sourceLine" id="cb13-29" data-line-number="29"><span class="co">#   3:  0    762  346  13  53   34 234  15 0.818  Cleveland Forest Citys</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30"><span class="co">#   4:  0    507  261   5  21   17 163   8 0.803    Fort Wayne Kekiongas</span></a>
<a class="sourceLine" id="cb13-31" data-line-number="31"><span class="co">#   5:  1   1536  622   2  33   46 323  33 0.868        New York Mutuals</span></a>
<a class="sourceLine" id="cb13-32" data-line-number="32"><span class="co">#  ---                                                                  </span></a>
<a class="sourceLine" id="cb13-33" data-line-number="33"><span class="co"># 145: 46   4344 1534 228 662  846 134 182 0.978          Anaheim Angels</span></a>
<a class="sourceLine" id="cb13-34" data-line-number="34"><span class="co"># 146: 42   4402 1387 176 543 1198 104 132 0.983    Arizona Diamondbacks</span></a>
<a class="sourceLine" id="cb13-35" data-line-number="35"><span class="co"># 147: 40   4328 1618 213 616  987 127 146 0.979       Milwaukee Brewers</span></a>
<a class="sourceLine" id="cb13-36" data-line-number="36"><span class="co"># 148: 41   4282 1421 183 515 1125  98 135 0.983          Tampa Bay Rays</span></a>
<a class="sourceLine" id="cb13-37" data-line-number="37"><span class="co"># 149: 34   4328 1450 193 627 1202  73 156 0.988           Miami Marlins</span></a>
<a class="sourceLine" id="cb13-38" data-line-number="38"><span class="co">#                              park attendance BPF PPF teamIDBR teamIDlahman45</span></a>
<a class="sourceLine" id="cb13-39" data-line-number="39"><span class="co">#   1:          South End Grounds I         NA 103  96      BOS            BS1</span></a>
<a class="sourceLine" id="cb13-40" data-line-number="40"><span class="co">#   2:      Union Base-Ball Grounds         NA 104 102      CHI            CH1</span></a>
<a class="sourceLine" id="cb13-41" data-line-number="41"><span class="co">#   3: National Association Grounds         NA  96 100      CLE            CL1</span></a>
<a class="sourceLine" id="cb13-42" data-line-number="42"><span class="co">#   4:               Hamilton Field         NA 101 107      KEK            FW1</span></a>
<a class="sourceLine" id="cb13-43" data-line-number="43"><span class="co">#   5:     Union Grounds (Brooklyn)         NA  93  92      NYU            NY2</span></a>
<a class="sourceLine" id="cb13-44" data-line-number="44"><span class="co">#  ---                                                                        </span></a>
<a class="sourceLine" id="cb13-45" data-line-number="45"><span class="co"># 145:   Edison International Field    2066982 102 103      ANA            ANA</span></a>
<a class="sourceLine" id="cb13-46" data-line-number="46"><span class="co"># 146:            Bank One Ballpark    3019654 101 101      ARI            ARI</span></a>
<a class="sourceLine" id="cb13-47" data-line-number="47"><span class="co"># 147:               County Stadium    1701796  99  99      MIL            ML4</span></a>
<a class="sourceLine" id="cb13-48" data-line-number="48"><span class="co"># 148:              Tropicana Field    1874962  98  97      TBR            TBA</span></a>
<a class="sourceLine" id="cb13-49" data-line-number="49"><span class="co"># 149:                 Marlins Park    1583014  93  93      MIA            FLO</span></a>
<a class="sourceLine" id="cb13-50" data-line-number="50"><span class="co">#      teamIDretro</span></a>
<a class="sourceLine" id="cb13-51" data-line-number="51"><span class="co">#   1:         BS1</span></a>
<a class="sourceLine" id="cb13-52" data-line-number="52"><span class="co">#   2:         CH1</span></a>
<a class="sourceLine" id="cb13-53" data-line-number="53"><span class="co">#   3:         CL1</span></a>
<a class="sourceLine" id="cb13-54" data-line-number="54"><span class="co">#   4:         FW1</span></a>
<a class="sourceLine" id="cb13-55" data-line-number="55"><span class="co">#   5:         NY2</span></a>
<a class="sourceLine" id="cb13-56" data-line-number="56"><span class="co">#  ---            </span></a>
<a class="sourceLine" id="cb13-57" data-line-number="57"><span class="co"># 145:         ANA</span></a>
<a class="sourceLine" id="cb13-58" data-line-number="58"><span class="co"># 146:         ARI</span></a>
<a class="sourceLine" id="cb13-59" data-line-number="59"><span class="co"># 147:         MIL</span></a>
<a class="sourceLine" id="cb13-60" data-line-number="60"><span class="co"># 148:         TBA</span></a>
<a class="sourceLine" id="cb13-61" data-line-number="61"><span class="co"># 149:         MIA</span></a></code></pre></div>
<p>Note that this approach can of course be combined with <code>.SDcols</code> to return only portions of the <code>data.table</code> for each <code>.SD</code> (with the caveat that <code>.SDcols</code> should be fixed across the various subsets)</p>
<p><em>NB</em>: <code>.SD[1L]</code> is currently optimized by <a href="https://Rdatatable.gitlab.io/data.table/library/data.table/html/datatable-optimize.html"><em><code>GForce</code></em></a> (<a href="https://stackoverflow.com/questions/22137591/about-gforce-in-data-table-1-9-2">see also</a>), <code>data.table</code> internals which massively speed up the most common grouped operations like <code>sum</code> or <code>mean</code> – see <code><a href="../reference/datatable-optimize.html">?GForce</a></code> for more details and keep an eye on/voice support for feature improvement requests for updates on this front: <a href="https://github.com/Rdatatable/data.table/issues/735">1</a>, <a href="https://github.com/Rdatatable/data.table/issues/2778">2</a>, <a href="https://github.com/Rdatatable/data.table/issues/523">3</a>, <a href="https://github.com/Rdatatable/data.table/issues/971">4</a>, <a href="https://github.com/Rdatatable/data.table/issues/1197">5</a>, <a href="https://github.com/Rdatatable/data.table/issues/1414">6</a></p>
</div>
<div id="grouped-regression" class="section level2">
<h2 class="hasAnchor">
<a href="#grouped-regression" class="anchor"></a>Grouped Regression</h2>
<p>Returning to the inquiry above regarding the relationship between <code>ERA</code> and <code>W</code>, suppose we expect this relationship to differ by team (i.e., there’s a different slope for each team). We can easily re-run this regression to explore the heterogeneity in this relationship as follows (noting that the standard errors from this approach are generally incorrect – the specification <code>ERA ~ W*teamID</code> will be better – this approach is easier to read and the <em>coefficients</em> are OK):</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="co"># Overall coefficient for comparison</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2">overall_coef =<span class="st"> </span>Pitching[ , <span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(ERA <span class="op">~</span><span class="st"> </span>W))[<span class="st">'W'</span>]]</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co"># use the .N &gt; 20 filter to exclude teams with few observations</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">Pitching[ , <span class="cf">if</span> (.N <span class="op">&gt;</span><span class="st"> </span>20L) .(<span class="dt">w_coef =</span> <span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(ERA <span class="op">~</span><span class="st"> </span>W))[<span class="st">'W'</span>]), by =<span class="st"> </span>teamID</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">          ][ , <span class="kw"><a href="https://rdrr.io/r/graphics/hist.html">hist</a></span>(w_coef, 20L, <span class="dt">las =</span> 1L,</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">                    <span class="dt">xlab =</span> <span class="st">'Fitted Coefficient on W'</span>,</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">                    <span class="dt">ylab =</span> <span class="st">'Number of Teams'</span>, <span class="dt">col =</span> <span class="st">'darkgreen'</span>,</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">                    <span class="dt">main =</span> <span class="st">'Team-Level Distribution</span><span class="ch">\n</span><span class="st">Win Coefficients on ERA'</span>)]</a>
<a class="sourceLine" id="cb14-9" data-line-number="9"><span class="kw"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span>(<span class="dt">v =</span> overall_coef, <span class="dt">lty =</span> 2L, <span class="dt">col =</span> <span class="st">'red'</span>)</a></code></pre></div>
<p><img src="datatable-sd-usage_files/figure-html/group_lm-1.png" width="100%"></p>
<p>While there is indeed a fair amount of heterogeneity, there’s a distinct concentration around the observed overall value.</p>
<p>The above is just a short introduction of the power of <code>.SD</code> in facilitating beautiful, efficient code in <code>data.table</code>!</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#what-is--sd">What is <code>.SD</code>?</a><ul class="nav nav-pills nav-stacked">
<li><a href="#loading-and-previewing-lahman-data">Loading and Previewing Lahman Data</a></li>
      </ul>
</li>
      <li>
<a href="#sd-on-ungrouped-data"><code>.SD</code> on Ungrouped Data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#column-subsetting--sdcols">Column Subsetting: <code>.SDcols</code></a></li>
      <li><a href="#column-type-conversion">Column Type Conversion</a></li>
      <li><a href="#controlling-a-models-right-hand-side">Controlling a Model’s Right-Hand Side</a></li>
      <li><a href="#conditional-joins">Conditional Joins</a></li>
      </ul>
</li>
      <li>
<a href="#grouped--sd-operations">Grouped <code>.SD</code> operations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#group-subsetting">Group Subsetting</a></li>
      <li><a href="#group-optima">Group Optima</a></li>
      <li><a href="#grouped-regression">Grouped Regression</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Matt Dowle, Arun Srinivasan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
