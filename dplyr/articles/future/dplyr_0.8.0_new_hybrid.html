<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New hybrid • dplyr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="New hybrid">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">dplyr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.8.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa fas fa-archive fa-lg"></span>
     
    R Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../../boot/index.html">boot</a>
    </li>
    <li>
      <a href="../../../broom/index.html">broom</a>
    </li>
    <li>
      <a href="../../../caret/index.html">caret</a>
    </li>
    <li>
      <a href="../../../cluster/index.html">cluster</a>
    </li>
    <li>
      <a href="../../../coefplot/index.html">coefplot</a>
    </li>
    <li>
      <a href="../../../data.table/index.html">data.table</a>
    </li>
    <li>
      <a href="../../../devtools/index.html">devtools</a>
    </li>
    <li>
      <a href="../../../dplyr/index.html">dplyr</a>
    </li>
    <li>
      <a href="../../../e1071/index.html">e1071</a>
    </li>
    <li>
      <a href="../../../forcats/index.html">forcats</a>
    </li>
    <li>
      <a href="../../../gbm/index.html">gbm</a>
    </li>
    <li>
      <a href="../../../ggplot2/index.html">ggplot2</a>
    </li>
    <li>
      <a href="../../../glmnet/index.html">glmnet</a>
    </li>
    <li>
      <a href="../../../gridExtra/index.html">gridExtra</a>
    </li>
    <li>
      <a href="../../../ISLR/index.html">ISLR</a>
    </li>
    <li>
      <a href="../../../MASS/index.html">MASS</a>
    </li>
    <li>
      <a href="../../../pdp/index.html">pdp</a>
    </li>
    <li>
      <a href="../../../pls/index.html">pls</a>
    </li>
    <li>
      <a href="../../../plyr/index.html">plyr</a>
    </li>
    <li>
      <a href="../../../pROC/index.html">pROC</a>
    </li>
    <li>
      <a href="../../../purrr/index.html">purrr</a>
    </li>
    <li>
      <a href="../../../randomForest/index.html">randomForest</a>
    </li>
    <li>
      <a href="../../../readr/index.html">readr</a>
    </li>
    <li>
      <a href="../../../rpart/index.html">rpart</a>
    </li>
    <li>
      <a href="../../../rpart.plot/index.html">rpart.plot</a>
    </li>
    <li>
      <a href="../../../stringr/index.html">stringr</a>
    </li>
    <li>
      <a href="../../../tibble/index.html">tibble</a>
    </li>
    <li>
      <a href="../../../tidyr/index.html">tidyr</a>
    </li>
    <li>
      <a href="../../../xgboost/index.html">xgboost</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../articles/dplyr.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/compatibility.html">dplyr compatibility</a>
    </li>
    <li>
      <a href="../../articles/future/dplyr_0.8.0.html">dplyr 0.8.0</a>
    </li>
    <li>
      <a href="../../articles/future/dplyr_0.8.0_new_hybrid.html">New hybrid</a>
    </li>
    <li>
      <a href="../../articles/programming.html">Programming with dplyr</a>
    </li>
    <li>
      <a href="../../articles/two-table.html">Two-table verbs</a>
    </li>
    <li>
      <a href="../../articles/window-functions.html">Window functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tidyverse/dplyr">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>New hybrid</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidyverse/dplyr/blob/master/../../vignettes/future/dplyr_0.8.0_new_hybrid.Rmd"><code>../../vignettes/future/dplyr_0.8.0_new_hybrid.Rmd</code></a></small>
      <div class="hidden name"><code>dplyr_0.8.0_new_hybrid.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>overview</h1>
<p>This is a complete redesign of how we evaluate expression in dplyr. We no longer attempt to evaluate part of an expression. We now either:</p>
<ul>
<li>recognize the entire expression, e.g. <code><a href="../../reference/n.html">n()</a></code> or <code><a href="https://rdrr.io/r/base/mean.html">mean(x)</a></code> and use C++ code to evaluate it (this is what we call hybrid evaluation now, but I guess another term would be better.</li>
<li>if not, we use standard evaluation in a suitable environment</li>
</ul>
</div>
<div id="data-mask" class="section level1">
<h1 class="hasAnchor">
<a href="#data-mask" class="anchor"></a>data mask</h1>
<p>When used internally in the c++ code, a tibble become one of the 3 classes <code>GroupedDataFrame</code>, <code>RowwiseDataFrame</code> or <code>NaturalDataFrame</code>. Most internal code is templated by these classes, e.g. <code>summarise</code> is:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">SEXP summarise_impl(DataFrame df, QuosureList dots) {</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  check_valid_colnames(df);</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="cf">if</span> (is&lt;RowwiseDataFrame&gt;(df)) {</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="cf">return</span> summarise_grouped&lt;RowwiseDataFrame&gt;(df, dots);</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  } <span class="cf">else</span> <span class="cf">if</span> (is&lt;GroupedDataFrame&gt;(df)) {</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="cf">return</span> summarise_grouped&lt;GroupedDataFrame&gt;(df, dots);</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">    <span class="cf">return</span> summarise_grouped&lt;NaturalDataFrame&gt;(df, dots);</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">}</a></code></pre></div>
<p>The <code>DataMask&lt;SlicedTibble&gt;</code> template class is used by both hybrid and standard evaluation to extract the relevant information from the columns (original columns or columns that have just been made by <code><a href="../../reference/mutate.html">mutate()</a></code> or <code><a href="../../reference/summarise.html">summarise()</a></code>)</p>
</div>
<div id="standard-evaluation" class="section level1">
<h1 class="hasAnchor">
<a href="#standard-evaluation" class="anchor"></a>standard evaluation</h1>
<div id="meta-information-about-the-groups" class="section level2">
<h2 class="hasAnchor">
<a href="#meta-information-about-the-groups" class="anchor"></a>meta information about the groups</h2>
<p>The functions <code><a href="../../reference/n.html">n()</a></code>, <code><a href="../../reference/ranking.html">row_number()</a></code> and <code><a href="../../reference/group_indices.html">group_indices()</a></code> when called without arguments lack contextual information, i.e. the current group size and index, so they look for that information a the special environment</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">n &lt;-<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">  <span class="kw">from_context</span>(<span class="st">"..group_size"</span>)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">}</a></code></pre></div>
<p>The DataMask class is responsible for updating the variables <code>..group_size</code> and <code>..group_number</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb3-1" data-line-number="1">    <span class="co">// update the data context variables, these are used by n(), ...</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    get_context_env()[<span class="st">"..group_size"</span>] = indices.size();</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    get_context_env()[<span class="st">"..group_number"</span>] = indices.group() + <span class="dv">1</span>;</a></code></pre></div>
<p>all other functions can just be called with standard evaluation in the data mask</p>
</div>
<div id="active-and-resolved-bindings" class="section level2">
<h2 class="hasAnchor">
<a href="#active-and-resolved-bindings" class="anchor"></a>active and resolved bindings</h2>
<p>When doing standard evaluation, we need to install a data mask that evaluates the symbols from the data to the relevant subset. The simple solution would be to update the data mask at each iteration with subsets for all the variables but that would be potentially expensive and a waste, as we might not need all of the variables at a given time, e.g. in this case:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/group_by.html">group_by</a></span>(Species) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/summarise.html">summarise</a></span>(<span class="dt">Sepal.Length =</span> <span class="op">+</span><span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(Sepal.Length))</a></code></pre></div>
<p>We only need to materialize <code>Sepal.Length</code>, we don’t need the other variables.</p>
<p><code>DataMask</code> installs an active binding for each variable in one of (the top) the environment in the data mask ancestry, the active binding function is generated by this function so that it holds an index and a pointer to the data mask in its enclosure.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">.make_active_binding_fun &lt;-<span class="st"> </span><span class="cf">function</span>(index, subsets){</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="kw">materialize_binding</span>(index, subsets)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  }</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">}</a></code></pre></div>
<p>When hit, the active binding calls the materialize_binding function :</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">// [[Rcpp::export]]</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">SEXP materialize_binding(<span class="dt">int</span> idx, XPtr&lt;DataMaskBase&gt; mask) {</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="cf">return</span> mask-&gt;materialize(idx);</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">}</a></code></pre></div>
<p>The <code>DataMask&lt;&gt;::materialize(idx)</code> method returns the materialized subset, but also: - install the result in the bottom environment of the data mask, so that it mask the active binding. The point is to call the active binding only once. - remembers that the binding at position <code>idx</code> has been materialized, so that before evaluating the same expression in the next group, it is proactively materialized, because it is very likely that we need the same variables for all groups</p>
<p>When we move to the next expression to evaluate, <code>DataMask</code> forgets about the materialized bindings so that the active binding can be triggered again as needed.</p>
<p>use case of the DataMask class</p>
<ul>
<li>before evaluating expressions, construct a DataMask from a tibble</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb7-1" data-line-number="1">DataMask&lt;SlicedTibble&gt; mask(tbl);</a></code></pre></div>
<ul>
<li>before evaluating a new expression, we need to <code>rechain(parent_env)</code> to prepare the data mask to evaluate expression with a given parent environment. This “forgets” about the materialized bindings.</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb8-1" data-line-number="1">mask.rechain(quosure.env());</a></code></pre></div>
<ul>
<li>before evaluating the expression ona new group, the indices are updated, this includes rematerializing the already materialized bindings</li>
</ul>
</div>
</div>
<div id="hybrid-evaluation" class="section level1">
<h1 class="hasAnchor">
<a href="#hybrid-evaluation" class="anchor"></a>hybrid evaluation</h1>
<div id="use-of-datamask" class="section level2">
<h2 class="hasAnchor">
<a href="#use-of-datamask" class="anchor"></a>Use of DataMask</h2>
<p>Hybrid evaluation also uses the <code>DataMask&lt;&gt;</code> class, but it only needs to quickly retrieve the data for an entire column. This is what the <code>maybe_get_subset_binding</code> method does.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb9-1" data-line-number="1">  <span class="co">// returns a pointer to the ColumnBinding if it exists</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">  <span class="co">// this is mostly used by the hybrid evaluation</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3">  <span class="at">const</span> ColumnBinding&lt;SlicedTibble&gt;* maybe_get_subset_binding(<span class="at">const</span> SymbolString&amp; symbol) <span class="at">const</span> {</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">    <span class="dt">int</span> pos = symbol_map.find(symbol);</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">    <span class="cf">if</span> (pos &gt;= <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">      <span class="cf">return</span> &amp;column_bindings[pos];</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">      <span class="cf">return</span> <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">    }</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">  }</a></code></pre></div>
<p>when the symbol map contains the binding, we get a <code>ColumnBinding&lt;SlicedTibble&gt;*</code>. These objects hold these fields:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb10-1" data-line-number="1">  <span class="co">// is this a summary binding, i.e. does it come from summarise</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="dt">bool</span> summary;</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">  <span class="co">// symbol of the binding</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  SEXP symbol;</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  <span class="co">// data. it is own either by the original data frame or by the</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">  <span class="co">// accumulator, so no need for additional protection here</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">  SEXP data;</a></code></pre></div>
<p>hybrid evaluation only needs <code>summary</code> and <code>data</code>.</p>
</div>
<div id="expression" class="section level2">
<h2 class="hasAnchor">
<a href="#expression" class="anchor"></a>Expression</h2>
<p>When attempting to evaluate an expression with the hybrid evaluator, we first construct an <code>Expression</code> object. This class has methods to quickly check if the expression can be managed, e.g.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb11-1" data-line-number="1">    <span class="co">// sum( &lt;column&gt; ) and base::sum( &lt;column&gt; )</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">    <span class="cf">if</span> (expression.is_fun(<span class="va">s_sum</span>, <span class="va">s_base</span>, ns_base)) {</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">      Column x;</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">      <span class="cf">if</span> (expression.is_unnamed(<span class="dv">0</span>) &amp;&amp; expression.is_column(<span class="dv">0</span>, x)) {</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">        <span class="cf">return</span> <span class="va">sum_</span>(data, x, <span class="co">/* na.rm = */</span> <span class="kw">false</span>, op);</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">      } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">        <span class="cf">return</span> R_UnboundValue;</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      }</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">    }</a></code></pre></div>
<p>This checks that the call matches <code>sum(&lt;column&gt;)</code> or <code>base::sum(&lt;column&gt;)</code> where <code>&lt;column&gt;</code> is a column from the data mask.</p>
<p>In that example, the <code>Expression</code> class checks that: - the first argument is not named - the first argument is a column from the data</p>
<p>Otherwise it means it is an expression that we can’t handle, so we return <code>R_UnboundValue</code> which is the hybrid evaluation way to signal it gives up on handling the expression, and that it should be evaluated with standard evaluation.</p>
<p>Expression has the following methods:</p>
<ul>
<li>
<code>inline bool is_fun(SEXP symbol, SEXP pkg, SEXP ns)</code> : are we calling <code>fun</code> ? If so does <code>fun</code> curently resolve to the function we intend to (it might not if the function is masked, which allows to do trghings like this:)</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="op">&gt;</span><span class="st"> </span>n &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="dv">42</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="op">&gt;</span><span class="st"> </span><span class="kw"><a href="../../reference/summarise.html">summarise</a></span>(iris, <span class="dt">nn =</span> <span class="kw"><a href="../../reference/n.html">n</a></span>())</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  nn</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="dv">1</span> <span class="dv">42</span></a></code></pre></div>
<ul>
<li><p><code>bool is_valid() const</code> : is the expression valid. the Expressio, constructor rules out a few expressions that hjave no chance of being handled, such as pkg::fun() when <code>pkg</code> is none of <code>dplyr</code>, <code>stats</code> or <code>base</code></p></li>
<li><p><code>SEXP value(int i) const</code> : the expression at position i</p></li>
<li><p><code>bool is_named(int i, SEXP symbol) const</code> : is the i’th argument named <code>symbol</code></p></li>
<li><p><code>bool is_scalar_logical(int i, bool&amp; test) const</code> : is the i’th argument a scalar logical, we need this for handling e.g. <code>na.rm = TRUE</code></p></li>
<li><p><code>bool is_scalar_int(int i, int&amp; out) const</code> is the i’th argument a scalar int, we need this for <code>n = &lt;int&gt;</code></p></li>
<li><p><code>bool is_column(int i, Column&amp; column) const</code> is the i’th argument a column.</p></li>
</ul>
</div>
<div id="hybrid_do" class="section level2">
<h2 class="hasAnchor">
<a href="#hybrid_do" class="anchor"></a>hybrid_do</h2>
<p>The <code>hybrid_do</code> function uses methods from <code>Expression</code> to quickly assess if it can handle the expression and then calls the relevant function from <code>dplyr::hybrid::</code> to create the result at once:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb13-1" data-line-number="1">    <span class="cf">if</span> (expression.is_fun(<span class="va">s_sum</span>, <span class="va">s_base</span>, ns_base)) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">      <span class="co">// sum( &lt;column&gt; ) and base::sum( &lt;column&gt; )</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">      Column x;</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">      <span class="cf">if</span> (expression.is_unnamed(<span class="dv">0</span>) &amp;&amp; expression.is_column(<span class="dv">0</span>, x)) {</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">        <span class="cf">return</span> <span class="va">sum_</span>(data, x, <span class="co">/* na.rm = */</span> <span class="kw">false</span>, op);</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">      }</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">    } <span class="cf">else</span> <span class="cf">if</span> (expression.is_fun(<span class="va">s_mean</span>, <span class="va">s_base</span>, ns_base)) {</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">      <span class="co">// mean( &lt;column&gt; ) and base::mean( &lt;column&gt; )</span></a>
<a class="sourceLine" id="cb13-9" data-line-number="9"></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">      Column x;</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">      <span class="cf">if</span> (expression.is_unnamed(<span class="dv">0</span>) &amp;&amp; expression.is_column(<span class="dv">0</span>, x)) {</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">        <span class="cf">return</span> <span class="va">mean_</span>(data, x, <span class="kw">false</span>, op);</a>
<a class="sourceLine" id="cb13-13" data-line-number="13">      }</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">    } <span class="cf">else</span> <span class="cf">if</span> ...</a></code></pre></div>
<p>The functions in the C++ <code>dplyr::hybrid::</code> namespace create objects whose classes hold: - the type of output they create - the information they need (e.g. the column, the value of na.rm, …)</p>
<p>These classes all have these methods: - <code><a href="../../reference/summarise.html">summarise()</a></code> to return a result of the same size as the number of groups. This is used when op is a <code>Summary</code>. This returns <code>R_UnboundValue</code> to give up when the class can’t do that, e.g. the classes behind <code>lag</code> - <code><a href="https://rdrr.io/r/stats/window.html">window()</a></code> to return a result of the same size as the number of rows in the original data set.</p>
<p>The classes typically don’t provide these methods directly, but rather inherit, via CRTP one of: - <code>HybridVectorScalarResult</code>, so that the class only has to provide a <code>process</code> method, for example the <code>Count</code> class:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">template</span> &lt;<span class="kw">typename</span> SlicedTibble&gt;</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span> Count : <span class="kw">public</span> HybridVectorScalarResult&lt;INTSXP, SlicedTibble, Count&lt;SlicedTibble&gt; &gt; {</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  <span class="kw">typedef</span> HybridVectorScalarResult&lt;INTSXP, SlicedTibble, Count&lt;SlicedTibble&gt; &gt; Parent ;</a>
<a class="sourceLine" id="cb14-5" data-line-number="5"></a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  Count(<span class="at">const</span> SlicedTibble&amp; data) : Parent(data) {}</a>
<a class="sourceLine" id="cb14-7" data-line-number="7"></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  <span class="dt">int</span> process(<span class="at">const</span> <span class="kw">typename</span> SlicedTibble::slicing_index&amp; indices) <span class="at">const</span> {</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">    <span class="cf">return</span> indices.size();</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">  }</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">} ;</a></code></pre></div>
<p><code>HybridVectorScalarResult</code> uses the result of <code>process</code> in both <code><a href="../../reference/summarise.html">summarise()</a></code> and <code><a href="https://rdrr.io/r/stats/window.html">window()</a></code></p>
<ul>
<li>
<code>HybridVectorVectorResult</code> expects a <code>fill</code> method, e.g. implementation of <code>ntile(n=&lt;int&gt;)</code> uses this class that derive from HybridVectorVectorResult.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw">template</span> &lt;<span class="kw">typename</span> SlicedTibble&gt;</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/class.html">class</a></span> Ntile1 : <span class="kw">public</span> HybridVectorVectorResult&lt;INTSXP, SlicedTibble, Ntile1&lt;SlicedTibble&gt; &gt; {</a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="kw">public</span>:</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  <span class="kw">typedef</span> HybridVectorVectorResult&lt;INTSXP, SlicedTibble, Ntile1&gt; Parent;</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">  Ntile1(<span class="at">const</span> SlicedTibble&amp; data, <span class="dt">int</span> <span class="va">ntiles_</span>): Parent(data), ntiles(<span class="va">ntiles_</span>) {}</a>
<a class="sourceLine" id="cb15-7" data-line-number="7"></a>
<a class="sourceLine" id="cb15-8" data-line-number="8">  <span class="dt">void</span> fill(<span class="at">const</span> <span class="kw">typename</span> SlicedTibble::slicing_index&amp; indices, Rcpp::IntegerVector&amp; out) <span class="at">const</span> {</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">    <span class="dt">int</span> m = indices.size();</a>
<a class="sourceLine" id="cb15-10" data-line-number="10">    <span class="cf">for</span> (<span class="dt">int</span> j = m - <span class="dv">1</span>; j &gt;= <span class="dv">0</span>; j--) {</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">      out[ indices[j] ] = (<span class="dt">int</span>)floor((ntiles * j) / m) + <span class="dv">1</span>;</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">  }</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"></a>
<a class="sourceLine" id="cb15-15" data-line-number="15"><span class="kw">private</span>:</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">  <span class="dt">int</span> ntiles;</a>
<a class="sourceLine" id="cb15-17" data-line-number="17">};</a></code></pre></div>
<p>The result of <code>fill</code> is only used in <code><a href="https://rdrr.io/r/stats/window.html">window()</a></code>. The <code><a href="../../reference/summarise.html">summarise()</a></code> method simpliy returns <code>R_UnboundValue</code> to give up.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">overview</a></li>
      <li><a href="#data-mask">data mask</a></li>
      <li>
<a href="#standard-evaluation">standard evaluation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#meta-information-about-the-groups">meta information about the groups</a></li>
      <li><a href="#active-and-resolved-bindings">active and resolved bindings</a></li>
      </ul>
</li>
      <li>
<a href="#hybrid-evaluation">hybrid evaluation</a><ul class="nav nav-pills nav-stacked">
<li><a href="#use-of-datamask">Use of DataMask</a></li>
      <li><a href="#expression">Expression</a></li>
      <li><a href="#hybrid_do">hybrid_do</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://hadley.nz">Hadley Wickham</a>, Romain François, Lionel Henry, Kirill Müller, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
